# PRD: 学习模式

## Introduction

在关卡选择页面添加"学习"入口，让学生在闯关前先系统地学习本关生字。通过"临摹→默写"两阶段练习，配合肉腿奖励机制，帮助学生熟悉生字后再进入战斗，提高闯关成功率。

## Goals

- 提供系统化的生字学习流程（临摹3遍 + 默写3遍）
- 通过肉腿奖励激励学生完成学习
- 支持学习进度保存，中途退出可继续
- 学习完成后可选择直接进入闯关

## User Stories

### US-001: 关卡页面添加学习按钮
**Description:** 作为学生，我想在关卡页面看到"学习"按钮，方便在闯关前先学习生字。

**Acceptance Criteria:**
- [ ] 在关卡卡片上添加"学习"按钮，与"预览/闯关/v2"并列
- [ ] 按钮样式与其他按钮协调（建议使用绿色/教育风格）
- [ ] 点击后跳转到学习界面，传递关卡 ID
- [ ] Typecheck passes

### US-002: 学习界面基础布局
**Description:** 作为学生，我想看到清晰的学习界面，知道当前学习哪个字。

**Acceptance Criteria:**
- [ ] 顶部显示进度（如"第 3/10 字"）和退出按钮
- [ ] 中部大字显示当前学习的汉字（临摹阶段）
- [ ] 显示拼音和组词提示
- [ ] 下方显示田字格书写区域
- [ ] 显示当前阶段（"临摹 1/3" 或 "默写 2/3"）
- [ ] Typecheck passes

### US-003: 临摹阶段逻辑
**Description:** 作为学生，我需要看着示范字临摹3遍正确后，才能进入默写阶段。

**Acceptance Criteria:**
- [ ] 示范字始终显示在书写区上方
- [ ] 每次书写后 OCR 判断正确性
- [ ] 正确：计数+1，显示鼓励反馈，清空田字格
- [ ] 错误：不计数，显示"再试一次"提示，清空田字格
- [ ] 正确3次后自动进入默写阶段
- [ ] Typecheck passes

### US-004: 默写阶段逻辑
**Description:** 作为学生，我需要在不看示范字的情况下默写3遍正确，才能完成该字学习。

**Acceptance Criteria:**
- [ ] 示范字隐藏（可显示拼音提示）
- [ ] 每次书写后 OCR 判断正确性
- [ ] 正确：计数+1，显示鼓励反馈
- [ ] 错误：显示示范字，进入"纠错临摹"状态
- [ ] 正确3次后完成该字学习，触发奖励动画
- [ ] Typecheck passes

### US-005: 默写错误纠错流程
**Description:** 作为学生，如果默写错误，我需要看着示范字写对1次后继续默写。

**Acceptance Criteria:**
- [ ] 默写错误后，示范字重新显示
- [ ] 提示"看着写一遍"
- [ ] 临摹正确1次后，示范字再次隐藏
- [ ] 继续默写阶段，正确计数保持（不重置）
- [ ] Typecheck passes

### US-006: 肉腿奖励动画
**Description:** 作为学生，每完成一个字的学习，我想看到肉腿从天上掉下来的奖励动画。

**Acceptance Criteria:**
- [ ] 完成一个字后，肉腿从屏幕上方掉落
- [ ] 小恐龙接住肉腿的动画效果
- [ ] 肉腿计数 +1 并显示在界面上
- [ ] 动画时长约 1-2 秒，不阻塞下一个字的学习
- [ ] Typecheck passes

### US-007: 肉腿数据持久化
**Description:** 作为开发者，我需要将肉腿数量保存到数据库，供后续解锁功能使用。

**Acceptance Criteria:**
- [ ] 在 database.ts 中添加肉腿（meat）字段或表
- [ ] 每获得肉腿时更新数据库
- [ ] 提供查询当前肉腿总数的 API
- [ ] Typecheck passes

### US-008: 学习进度保存
**Description:** 作为学生，如果中途退出学习，下次可以从上次的位置继续。

**Acceptance Criteria:**
- [ ] 保存当前学习的关卡 ID 和字索引
- [ ] 保存当前字的阶段（临摹/默写）和正确计数
- [ ] 退出时自动保存进度
- [ ] 再次进入同一关卡学习时，询问"继续上次"或"重新开始"
- [ ] Typecheck passes

### US-009: 学习完成庆祝
**Description:** 作为学生，完成全部生字学习后，我想看到庆祝动画。

**Acceptance Criteria:**
- [ ] 显示礼花/彩带庆祝动画
- [ ] 显示本次获得的肉腿总数
- [ ] 显示两个按钮："返回关卡"和"开始闯关"
- [ ] 点击"开始闯关"跳转到战斗页面
- [ ] Typecheck passes

### US-010: 学习界面退出确认
**Description:** 作为学生，如果中途退出学习，需要确认以防误触。

**Acceptance Criteria:**
- [ ] 点击退出按钮时显示确认弹窗
- [ ] 弹窗提示"进度已保存，确定退出吗？"
- [ ] 提供"继续学习"和"退出"选项
- [ ] Typecheck passes

## Functional Requirements

- FR-1: 关卡页面每个关卡卡片添加"学习"按钮
- FR-2: 学习界面顶部显示进度、退出按钮、肉腿计数
- FR-3: 临摹阶段显示示范字，正确3次后进入默写
- FR-4: 默写阶段隐藏示范字，正确3次后完成该字
- FR-5: 默写错误时显示示范字，临摹正确1次后继续默写
- FR-6: 每完成一个字，播放肉腿掉落动画，计数+1
- FR-7: 肉腿数量持久化存储，累计可用于后续解锁功能
- FR-8: 学习进度自动保存，支持断点续学
- FR-9: 全部完成后显示庆祝动画和结果统计
- FR-10: 退出时显示确认弹窗，防止误触

## Non-Goals

- 不实现肉腿兑换/解锁功能（本 PRD 只实现积累）
- 不实现学习模式的难度调整
- 不实现字的选择性学习（本期学习全部生字）
- 不实现学习数据统计报告

## Design Considerations

### UI 布局

```
┌─────────────────────────────────┐
│  ← 退出    第 3/10 字    🍖 x5  │  顶部栏
├─────────────────────────────────┤
│                                 │
│           好                    │  示范字（默写时隐藏）
│          hǎo                    │  拼音
│        "好人"                   │  组词提示
│                                 │
│      ┌─────────────┐            │
│      │   田字格    │            │  书写区域
│      │   书写区    │            │
│      └─────────────┘            │
│                                 │
│       临摹 2/3 ✓✓○              │  进度指示
│                                 │
└─────────────────────────────────┘
```

### 动画效果

- 肉腿掉落：从顶部掉落，带有轻微弹跳效果
- 小恐龙：在底部接住肉腿，露出开心表情
- 庆祝礼花：使用粒子效果或 Lottie 动画

### 复用组件

- `WritingPad.tsx` - 田字格书写组件
- `GameSprites.tsx` - 小恐龙精灵（可能需要扩展）

## Technical Considerations

### 数据结构

```typescript
// 学习进度
interface LearningProgress {
  levelId: string;
  characterIndex: number;
  stage: 'tracing' | 'dictation';
  correctCount: number;
  earnedMeat: number;
  lastUpdated: string;
}

// 肉腿记录
interface MeatRecord {
  totalMeat: number;
  lastEarnedAt: string;
}
```

### 数据库更新

- 新增 `learning_progress` 表存储学习进度
- 新增 `user_stats` 表的 `total_meat` 字段（或新建表）

### 路由

- 新增 `app/learning.tsx` 页面
- 路由参数：`levelId`

## Success Metrics

- 学生能在 2 分钟内完成一个字的学习（临摹+默写）
- 学习完成后闯关成功率提升
- 肉腿奖励机制激励学生主动使用学习功能

## Open Questions

1. 肉腿积累到多少可以解锁什么内容？（待后续 PRD 定义）
2. 是否需要显示历史学习记录？
3. 临摹阶段是否需要显示笔顺引导？
